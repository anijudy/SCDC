<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SCDC: Bulk Gene Expression Deconvolution by Multiple Single-Cell RNA Sequencing References • SCDC</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="SCDC: Bulk Gene Expression Deconvolution by Multiple Single-Cell RNA Sequencing References">
<meta property="og:description" content="SCDC">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SCDC</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../articles/SCDC.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">References</a>
</li>
<li>
  <a href="../articles/web/SCDC_data.html">Data</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">
    <span class="fa fa-file-code-o"></span>
     
    functions
  </a>
</li>
<li>
  <a href="https://github.com/meichendong/SCDC">
    <span class="fa fa-github fa-lg"></span>
     
    github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>SCDC: Bulk Gene Expression Deconvolution by Multiple Single-Cell RNA Sequencing References</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/meichendong/SCDC/blob/master/vignettes/SCDC.Rmd"><code>vignettes/SCDC.Rmd</code></a></small>
      <div class="hidden name"><code>SCDC.Rmd</code></div>

    </div>

    
    
<p><strong>SCDC</strong> adopts an ENSEMBLE method to integrate deconvolution results across methods and datasets, giving reference data that are more close to the bulk RNA-seq data higher weights, implicitly addressing the batch-effect confounding when multiple scRNA-seq reference sets are available.</p>
<p>Our paper is published at <a href="https://doi.org/10.1093/bib/bbz166">Briefings In Bioinformatics</a>.</p>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<div class="sourceCode"><pre class="downlit">
<span class="co">if</span> (<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/library.html">require</a></span>(<span class="st"><a href="https://devtools.r-lib.org">"devtools"</a></span>)) {
  <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"devtools"</span>)
}
<span class="kw">devtools</span>::<span class="fu"><a href="https://devtools.r-lib.org//reference/remote-reexports.html">install_github</a></span>(<span class="st">"meichendong/SCDC"</span>)
</pre></div>
</div>
<div id="data-input" class="section level2">
<h2 class="hasAnchor">
<a href="#data-input" class="anchor"></a>Data Input</h2>
<p>SCDC takes <code>ExpressionSet</code> objects with raw read counts as input. <code>ExpressionSet</code> object is based on the package <a href="https://bioconductor.org/packages/release/bioc/html/Biobase.html"><em>Biobase</em></a>, which mainly stores data matrix (genes by samples), featureData (information about genes), and phenoData (information about samples, like the clustering results, subjects, conditions). We also enable a quick construction of the ExpressionSet object by the function <code><a href="../reference/getESET.html">getESET()</a></code>. Here we show a toy example:</p>
<div class="sourceCode"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/meichendong/SCDC">SCDC</a></span>)
<span class="co">#&gt; Warning: replacing previous import 'vctrs::data_frame' by 'tibble::data_frame'</span>
<span class="co">#&gt; when loading 'dplyr'</span>
<span class="kw">counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="fl">0</span><span class="op">:</span><span class="fl">500</span>, <span class="fl">25</span>), nrow = <span class="fl">5</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="kw">counts</span>) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"cell"</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, sep = <span class="st">""</span>)
<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="kw">counts</span>) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"gene"</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, sep = <span class="st">""</span>)
<span class="kw">counts</span>
<span class="co">#&gt;       cell1 cell2 cell3 cell4 cell5</span>
<span class="co">#&gt; gene1    91   235   320    98   206</span>
<span class="co">#&gt; gene2   259   160   367   105   123</span>
<span class="co">#&gt; gene3   229   211   238   236   322</span>
<span class="co">#&gt; gene4    74   106   359   141    72</span>
<span class="co">#&gt; gene5   125   306   401    84   373</span>
<span class="kw">fdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="kw">counts</span>)
<span class="kw">pdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(cellname = <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="kw">counts</span>), subjects = <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"patient"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>,<span class="fl">5</span>)))
<span class="kw">eset</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/getESET.html">getESET</a></span>(<span class="kw">counts</span>, fdata = <span class="kw">fdata</span>, pdata = <span class="kw">pdata</span>)
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span>(<span class="kw">eset</span>)
<span class="co">#&gt; [1] "ExpressionSet"</span>
<span class="co">#&gt; attr(,"package")</span>
<span class="co">#&gt; [1] "Biobase"</span>
</pre></div>
<p>As an illustration of the <strong>SCDC</strong> framework, we analyze the pancreatic islet data as presented in our paper. Three public scRNA-seq datasets from <a href="https://www.sciencedirect.com/science/article/pii/S2405471216302666?via%3Dihub">Baron et al. (2016)</a>, <a href="https://www.sciencedirect.com/science/article/pii/S1550413116304363?via%3Dihub">Segerstolpe et al. (2016)</a> and <a href="https://www.sciencedirect.com/science/article/pii/S155041311630434X?via%3Dihub">Xin et al. (2016)</a> are used; a bulk RNA-seq dataset from <a href="https://www.pnas.org/content/111/38/13924">Fadista et al. (2014)</a> is used in the real data analysis. We also applied our method to a three-cell-line mixture data from <a href="https://unclineberger.org/peroulab/">Perou lab</a>, where the cell lines MDA-MB-468, MCF-7, and normal fibroblast cells are cultured by the ratio 6:3:1. Both scRNA-seq and bulk RNA-seq data are available.</p>
<p>The processed data is available for download at the <a href="https://meichendong.github.io/SCDC/articles/web/SCDC_data.html">SCDC data page</a>.</p>
</div>
<div id="scdc-pre-process-of-scrna-seq-data" class="section level2">
<h2 class="hasAnchor">
<a href="#scdc-pre-process-of-scrna-seq-data" class="anchor"></a>SCDC Pre-process of scRNA-seq Data</h2>
<p>For each single-cell dataset with raw counts, we can first explore the demographic information by the visualization function <code>DemoPlot</code>. Here, single cells from each subject are summarized by total counts, counts per cell type, and the overall composition. This gives us a general understanding of a dataset. Take scRNA-seq data of healthy subjects from Segerstolpe et al. as an example, and we derive the following plot:</p>
<div class="sourceCode"><pre class="downlit">
<span class="kw">ct1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"mediumorchid1"</span>,<span class="st">"mediumpurple1"</span>,<span class="st">"lightskyblue"</span>,<span class="st">"seagreen1"</span>,<span class="st">"yellow"</span>,<span class="st">"tan1"</span>,<span class="st">"azure3"</span>)
<span class="kw">seger</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"segerstolpe.rds"</span>)
<span class="fu"><a href="../reference/DemoPlot.html">DemoPlot</a></span>(<span class="kw">seger</span>, cluster = <span class="st">"cluster"</span>, sample = <span class="st">"sample"</span>, select.ct = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"delta"</span>,<span class="st">"gamma"</span>,<span class="st">"ductal"</span>,<span class="st">"acinar"</span>), Palette = <span class="kw">ct1</span>)
</pre></div>
<center>
<img src="../../../../../../../OneDrive%20-%20University%20of%20North%20Carolina%20at%20Chapel%20Hill/994/SCDC/package/SCDC2/SCDC/vignettes/demoplot.png" alt="scRNA-seq from Segerstolpe et al." width="400">
</center>
<p>To make SCDC robust to single-cell clustering, a quality control procedure is performed as a first step to remove cells with questionable cell-type assignments, as well as cells with low library preparation and sequencing quality. Specifically, each single cell is treated as a “bulk” sample and its cell-type composition can be derived by a first-pass run of SCDC. The threshold of keeping a single cell from an assigned cluster is chosen as 0.7 in this illustration example. This user-defined threshold should be selected carefully, to achieve the effect of quality control of single cells without obstructing the performance on the downstream analysis. An unproper threshold could potentially lead to filtering out a large proportion of cells from rare cell types. To be conservative, this can be chosen from (0.5,0.7).</p>
<div class="sourceCode"><pre class="downlit">
<span class="kw">seger.qc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SCDC_qc.html">SCDC_qc</a></span>(<span class="kw">seger</span>, ct.varname = <span class="st">"cluster"</span>, sample = <span class="st">"sample"</span>, scsetname = <span class="st">"Segerstolpe"</span>,
                  ct.sub = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"delta"</span>,<span class="st">"gamma"</span>,<span class="st">"ductal"</span>,<span class="st">"acinar"</span>), qcthreshold = <span class="fl">0.7</span>) 
<span class="kw">seger.qc</span><span class="op">$</span><span class="kw">heatfig</span>
</pre></div>
<center>
<img src="../../../../../../../OneDrive%20-%20University%20of%20North%20Carolina%20at%20Chapel%20Hill/994/SCDC/package/SCDC2/SCDC/vignettes/cqc.png" alt="scRNA-seq from Segerstolpe et al. Clustering QC" width="350">
</center>
<p>Similarly, we can perform clustering QC for single cells from only one subject using function <code><a href="../reference/SCDC_qc_ONE.html">SCDC_qc_ONE()</a></code>.</p>
</div>
<div id="scdc-on-simulated-data" class="section level2">
<h2 class="hasAnchor">
<a href="#scdc-on-simulated-data" class="anchor"></a>SCDC on Simulated Data</h2>
<p>SCDC allows users to construct pseudo bulk samples in two ways:</p>
<ul>
<li><p><code><a href="../reference/generateBulk_allcells.html">generateBulk_allcells()</a></code>: Sum up gene-wise raw read counts per subject, and the true cell-type proportion is consistent with the single cell clustering result.</p></li>
<li><p><code><a href="../reference/generateBulk_norep.html">generateBulk_norep()</a></code>: Randomly sample single cells from each of the cell types of interest without replacement, and then sum up raw read counts per subject. The cell-type proportions are different from single cell clustering result.</p></li>
</ul>
<p>Here, we use the <code>ExpressionSet</code> objects after the clustering-QC of each scRNA-seq dataset. Read in the processed objects downloaded from our webpage:</p>
<div class="sourceCode"><pre class="downlit">
<span class="co"># ExpressionSet objects from the three different scRNA-seq resources</span>
<span class="co"># setwd("your/working/directory")</span>
<span class="kw">qc.seger</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"qc_segerstolpe.rds"</span>)
<span class="kw">qc.baron</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"qc_baron.rds"</span>)
<span class="kw">qc.xin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"qc_xin.rds"</span>)
</pre></div>
<p>Then create the <em>pseudo bulk</em> samples as follows. <code>ct.varname</code> specifies the variable name of your single cell clustering result variable. <code>sample</code> specifies the variable indicating subjects or individuals information. <code>ct.sub</code> specifies the subset of cell types you want to use to construct pseudo bulk samples.</p>
<div class="sourceCode"><pre class="downlit">
<span class="co">## (1) using all single cells</span>
<span class="kw">pseudo.seger</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generateBulk_allcells.html">generateBulk_allcells</a></span>(<span class="kw">qc.seger</span><span class="op">$</span><span class="kw">sc.eset.qc</span>, ct.varname = <span class="st">"cluster"</span>, sample = <span class="st">"sample"</span>, ct.sub = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"delta"</span>,<span class="st">"gamma"</span>))

<span class="co">## (2) using random proportions of single cells</span>
<span class="kw">pseudo.seger.rand</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generateBulk_norep.html">generateBulk_norep</a></span>(<span class="kw">qc.seger</span><span class="op">$</span><span class="kw">sc.eset.qc</span>, ct.varname = <span class="st">"cluster"</span>, sample = <span class="st">"sample"</span>, ct.sub = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"delta"</span>,<span class="st">"gamma"</span>), nbulk = <span class="fl">3</span>)

<span class="co">## we know the true relative proportions for the pseudo bulk samples:</span>
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">pseudo.seger</span><span class="op">$</span><span class="kw">truep</span>,<span class="fl">3</span>)
<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">pseudo.seger.rand</span><span class="op">$</span><span class="kw">true_p</span>,<span class="fl">3</span>)
</pre></div>
<p>The constructed <em>pseudo bulk</em> object includes the true cell-type proportion matrix <code>pseudo.seger$truep</code> and the <code>ExpressionSet</code> object <code>pseudo.seger$pseudo_eset</code>.</p>
<p>Note that if the 'library size' factors do not reflect the real 'cell size' factors relationship according to prior biological knowledge, you can specify the <code>ct.cell.size</code> values in the <code><a href="../reference/SCDC_prop.html">SCDC_prop()</a></code> or <code><a href="../reference/SCDC_basis.html">SCDC_basis()</a></code> or <code><a href="../reference/SCDC_ENSEMBLE.html">SCDC_ENSEMBLE()</a></code> functions. To perform deconvolution using one reference scRNA-seq dataset, use the <code><a href="../reference/SCDC_prop.html">SCDC_prop()</a></code> function:</p>
<div class="sourceCode"><pre class="downlit">
<span class="kw">bulkseger.scseger</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SCDC_prop.html">SCDC_prop</a></span>(bulk.eset = <span class="kw">pseudo.seger</span><span class="op">$</span><span class="kw">pseudo_eset</span>, sc.eset = <span class="kw">qc.seger</span><span class="op">$</span><span class="kw">sc.eset.qc</span>, ct.varname = <span class="st">"cluster"</span>, sample = <span class="st">"sample"</span>, ct.sub = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"delta"</span>,<span class="st">"gamma"</span>), truep = <span class="kw">pseudo.seger</span><span class="op">$</span><span class="kw">truep</span>)
<span class="kw">bulkseger.scbaron</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SCDC_prop.html">SCDC_prop</a></span>(bulk.eset = <span class="kw">pseudo.seger</span><span class="op">$</span><span class="kw">pseudo_eset</span>, sc.eset = <span class="kw">qc.baron</span><span class="op">$</span><span class="kw">sc.eset.qc</span>, ct.varname = <span class="st">"cluster"</span>, sample = <span class="st">"sample"</span>, ct.sub = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"delta"</span>,<span class="st">"gamma"</span>), truep = <span class="kw">pseudo.seger</span><span class="op">$</span><span class="kw">truep</span>)
<span class="kw">bulkseger.scxin</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SCDC_prop.html">SCDC_prop</a></span>(bulk.eset = <span class="kw">pseudo.seger</span><span class="op">$</span><span class="kw">pseudo_eset</span>, sc.eset = <span class="kw">qc.xin</span><span class="op">$</span><span class="kw">sc.eset.qc</span>, ct.varname = <span class="st">"cluster"</span>, sample = <span class="st">"sample"</span>, ct.sub = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"delta"</span>,<span class="st">"gamma"</span>), truep = <span class="kw">pseudo.seger</span><span class="op">$</span><span class="kw">truep</span>)

<span class="kw">bulkseger.scseger</span><span class="op">$</span><span class="kw">peval</span><span class="op">$</span><span class="kw">evals.table</span>
<span class="co">#&gt;         RMSD     mAD      R</span>
<span class="co">#&gt; SCDC 0.03352 0.02553 0.9912</span>
<span class="kw">bulkseger.scbaron</span><span class="op">$</span><span class="kw">peval</span><span class="op">$</span><span class="kw">evals.table</span>
<span class="co">#&gt;         RMSD     mAD     R</span>
<span class="co">#&gt; SCDC 0.08337 0.06499 0.954</span>
<span class="kw">bulkseger.scxin</span><span class="op">$</span><span class="kw">peval</span><span class="op">$</span><span class="kw">evals.table</span>
<span class="co">#&gt;         RMSD     mAD      R</span>
<span class="co">#&gt; SCDC 0.19058 0.15449 0.9331</span>
</pre></div>
<p>We can observe the discrepancy of performance using different datasets. In this example, when using single cells from the reference dataset Segerstolpe et al., we derive the highest Pearson correlation, and the lowest RMSD and mAD.</p>
<p>Next, we will explore the ENSEMBLE method integrating all the three scRNA-seq reference datasets using the pseudo bulk samples constructed above. Here we offered three methods to derive the ENSEMBLE weights: 'Grid search', 'LAD', and 'NNLS'. The default setting is using all these three methods. The search length is a parameter representing the search step size, which is related to the grid search method.</p>
<div class="sourceCode"><pre class="downlit">
<span class="co">#input the list of single cell ExpressionSet objects</span>
<span class="kw">pancreas.sc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(baron = <span class="kw">qc.baron</span><span class="op">$</span><span class="kw">sc.eset.qc</span>,
                    seger = <span class="kw">qc.seger</span><span class="op">$</span><span class="kw">sc.eset.qc</span>,
                    xin = <span class="kw">qc.xin</span><span class="op">$</span><span class="kw">sc.eset.qc</span>)
<span class="co"># This might take several minutes, depending on the search.length set by user.</span>
<span class="kw">PS_ensemble</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SCDC_ENSEMBLE.html">SCDC_ENSEMBLE</a></span>(bulk.eset = <span class="kw">pseudo.seger</span><span class="op">$</span><span class="kw">pseudo_eset</span>, sc.eset.list = <span class="kw">pancreas.sc</span>, ct.varname = <span class="st">"cluster"</span>,
                             sample = <span class="st">"sample"</span>, truep = <span class="kw">pseudo.seger</span><span class="op">$</span><span class="kw">truep</span>[<span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span>(<span class="kw">pseudo.seger</span><span class="op">$</span><span class="kw">truep</span>),], ct.sub =  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"delta"</span>,<span class="st">"gamma"</span>), search.length = <span class="fl">0.01</span>)
<span class="kw">PS_ensemble</span><span class="op">$</span><span class="kw">w_table</span>
<span class="co">#               w1   w2   w3   RMSD_Y    mAD_Y Pearson_Y Spearman_Y RMSD_prop mAD_prop R_prop</span>
<span class="co">#inverse SSE  0.06 0.66 0.28 7.146419 4.415475 0.7545354  0.8478534   0.06692  0.05541 0.9839</span>
<span class="co">#LAD          0.00 1.00 0.00 6.706079 4.225556 0.8183429  0.8610900   0.03376  0.02511 0.9907</span>
<span class="co">#Pearson_prop 0.02 0.93 0.05 6.720294 4.237310 0.8155518  0.8608889   0.03627  0.02779 0.9913</span>
<span class="co">#mAD_Y        0.00 1.00 0.00 6.705799 4.225710 0.8185645  0.8611222   0.03376  0.02509 0.9907</span>
<span class="co">#Spearman_Y   0.00 0.97 0.03 6.703476 4.229452 0.8192302  0.8613582   0.03483  0.02661 0.9912</span>
</pre></div>
<p>Interpretation of the <code>PS_ensemble$w_table</code>: columns w1,w2,w3 are the weight assigned to each of the reference dataset result. The columns 4-11 are the metrics we used to derived the optimal weights for the references. For example, 'RMSD_Y' stands for the RMSD value based on observed and predicted expression 'Y' values while using the set of weights suggested on the left. For each row, these are the different optimization methods/criteria we used to derive the corresponding weights. For example, the first row suggests (0.06, 0.66, 0.28) for results derived from reference 1 to 3. This set of weights are selected based on calculating the inverse SSE value. Likewise, LAD stands for minimizing the least absolute deviation values based on 'Y'. Pearson_prop only works when you have the true sample composition input (that is, in the <code><a href="../reference/SCDC_ENSEMBLE.html">SCDC_ENSEMBLE()</a></code> function, the <code>truep</code> option is not <code>NULL</code>.). This aims to find weights such that the final ensemble proportions have the highest Pearson correlation with the truth. <code>mAD_Y</code> is the grid search result, where we calculated the result from each weights combination, and chose the one minimized the mAD(Yobs, Ypredict). <code>Spearman_Y</code> is the grid search result, where we calculated the result from each weights combination, and chose the one maximized the Spearman corr(Yobs, Ypredict). If you have many reference datasets, say more than 4, then it's not recommended to use the 'grid search method' since it would be time consuming. You can turn off the grid search by setting <code>grid.search = F</code>.</p>
<p>In this case, SCDC ENSEMBLE weights suggest that the weight for results from reference dataset Segerstolpe et al. to be one. Hence, the final estimated cell-type proportions can be found at <code>PS_ensemble$prop.only$seger</code> or <code>PS_ensemble$prop.list$seger$prop.est.mvw</code>.</p>
</div>
<div id="scdc-on-real-bulk-rna-seq-data" class="section level2">
<h2 class="hasAnchor">
<a href="#scdc-on-real-bulk-rna-seq-data" class="anchor"></a>SCDC on Real Bulk RNA-seq Data</h2>
<p>Here, we move on to analyze the real pancreatic islet bulk RNA-seq dataset. Fadista et al. (2014) provided 89 bulk samples, of which 77 samples have the HbA1c level information(an important biomarker for the Type II diabetes). Hence, we focus on the deconvolution for the 77 bulk samples (51 healthy and 26 diabetic). To allow the basis matrix to reflect the potentially different gene expression patterns between the cases and controls, we performed the ENSEMBLE weight selection procedures for the samples from the two classes (normal and T2D) separately.</p>
<div class="sourceCode"><pre class="downlit">
<span class="kw">fadista_77</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"fadista_77.rds"</span>)
<span class="co"># setting the search.length as 0.01 might take several minutes to finish the ENSEMBLE procedure.</span>
<span class="kw">fadista.healthy.ens</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SCDC_ENSEMBLE.html">SCDC_ENSEMBLE</a></span>(bulk.eset = <span class="kw">fadista_77</span>[,<span class="kw">fadista_77</span><span class="op">$</span><span class="kw">hba1c_class2</span> <span class="op">==</span> <span class="st">"Normal"</span>], sc.eset.list = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(baronh = <span class="kw">qc.baron</span><span class="op">$</span><span class="kw">sc.eset.qc</span>, segerh = <span class="kw">qc.seger</span><span class="op">$</span><span class="kw">sc.eset.qc</span>), ct.varname = <span class="st">"cluster"</span>,
                               sample = <span class="st">"sample"</span>, truep = <span class="kw">NULL</span>, ct.sub =  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"delta"</span>,<span class="st">"gamma"</span>,<span class="st">"acinar"</span>,<span class="st">"ductal"</span>), search.length = <span class="fl">0.01</span>, grid.search = <span class="kw">T</span>)  

<span class="kw">fadista.t2d.ens</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SCDC_ENSEMBLE.html">SCDC_ENSEMBLE</a></span>(bulk.eset = <span class="kw">fadista_77</span>[,<span class="kw">fadista_77</span><span class="op">$</span><span class="kw">hba1c_class2</span> <span class="op">==</span> <span class="st">"T2D"</span>], sc.eset.list = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(baronh = <span class="kw">qc.baron</span><span class="op">$</span><span class="kw">sc.eset.qc</span>, segerh = <span class="kw">qc.seger</span><span class="op">$</span><span class="kw">sc.eset.qc</span>), ct.varname = <span class="st">"cluster"</span>,
                               sample = <span class="st">"sample"</span>, truep = <span class="kw">NULL</span>, ct.sub =  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"delta"</span>,<span class="st">"gamma"</span>,<span class="st">"acinar"</span>,<span class="st">"ductal"</span>), search.length = <span class="fl">0.01</span>, grid.search = <span class="kw">T</span>)  
<span class="co">#&gt; fadista.healthy.ens$w_table</span>
<span class="co">#               w1   w2   RMSD_Y    mAD_Y Pearson_Y Spearman_Y</span>
<span class="co">#inverse SSE  0.37 0.63 12.94834 5.844663 0.3419521  0.6552073</span>
<span class="co">#LAD          0.17 0.83 12.62988 5.834102 0.3451222  0.6489382 </span>
<span class="co">#mAD_Y        0.24 0.76 12.68422 5.828969 0.3456796  0.6524225 </span>
<span class="co">#Spearman_Y   0.40 0.60 13.02000 5.850878 0.3406539  0.6552603</span>
<span class="co">#&gt; fadista.t2d.ens$w_table</span>
<span class="co">#               w1   w2   RMSD_Y    mAD_Y Pearson_Y Spearman_Y</span>
<span class="co">#inverse SSE  0.41 0.59 11.60516 5.492857 0.3950583  0.6889226 </span>
<span class="co">#LAD          0.33 0.67 11.50850 5.494326 0.3962562  0.6870404 </span>
<span class="co">#mAD_Y        0.38 0.62 11.56228 5.492216 0.3957707  0.6884008 </span>
<span class="co">#Spearman_Y   0.48 0.52 11.75522 5.500820 0.3918644  0.6894475</span>
</pre></div>
<p>To compare the ENSEMBLE results to the deconvolution results using one reference dataset only, we visualize the estimated proportions as following:</p>
<div class="sourceCode"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/hadley/reshape">reshape2</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span>)
<span class="kw">getPropBox</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">ens_h</span>, <span class="kw">ens_d</span>, <span class="kw">metric</span> = <span class="kw">NULL</span>, <span class="kw">ref</span>, <span class="kw">input_wt</span> = <span class="kw">NULL</span>){
  <span class="co">if</span> (<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="kw">input_wt</span>)){
    <span class="kw">prop.h</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(<span class="fu"><a href="../reference/wt_prop.html">wt_prop</a></span>(<span class="kw">input_wt</span>, <span class="kw">ens_h</span><span class="op">$</span><span class="kw">prop.only</span>))
    <span class="kw">prop.d</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(<span class="fu"><a href="../reference/wt_prop.html">wt_prop</a></span>(<span class="kw">input_wt</span>, <span class="kw">ens_d</span><span class="op">$</span><span class="kw">prop.only</span>))
  } <span class="co">else</span> {
    <span class="kw">prop.h</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(<span class="fu"><a href="../reference/wt_prop.html">wt_prop</a></span>(<span class="kw">ens_h</span><span class="op">$</span><span class="kw">w_table</span>[<span class="kw">metric</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>], <span class="kw">ens_h</span><span class="op">$</span><span class="kw">prop.only</span>))
    <span class="kw">prop.d</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(<span class="fu"><a href="../reference/wt_prop.html">wt_prop</a></span>(<span class="kw">ens_d</span><span class="op">$</span><span class="kw">w_table</span>[<span class="kw">metric</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>], <span class="kw">ens_d</span><span class="op">$</span><span class="kw">prop.only</span>))
  }
  <span class="kw">prop2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">prop.h</span>, <span class="kw">prop.d</span>)
  <span class="kw">prop2</span><span class="op">$</span><span class="kw">condition</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"Normal"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">prop.h</span>)), <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"T2D"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">prop.d</span>)))
  
  <span class="kw">dtmelt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span>(<span class="kw">prop2</span>, id.vars = <span class="st">"condition"</span>)
  <span class="kw">dtmelt</span><span class="op">$</span><span class="kw">ref</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="kw">ref</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw">dtmelt</span>)
}

<span class="kw">fdt.ens.spearman</span> <span class="op">&lt;-</span> <span class="fu">getPropBox</span>(ens_h = <span class="kw">fadista.healthy.ens</span>, ens_d = <span class="kw">fadista.t2d.ens</span>, metric = <span class="fl">1</span>, ref = <span class="st">"ENSEMBLE+SpearmanR"</span>)
<span class="kw">fdt.seger</span> <span class="op">&lt;-</span> <span class="fu">getPropBox</span>(ens_h = <span class="kw">fadista.healthy.ens</span>, ens_d = <span class="kw">fadista.t2d.ens</span>,  ref = <span class="st">"Segerstolpe"</span>, input_wt = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1</span>))
<span class="kw">fdt.baron</span> <span class="op">&lt;-</span> <span class="fu">getPropBox</span>(ens_h = <span class="kw">fadista.healthy.ens</span>, ens_d = <span class="kw">fadista.t2d.ens</span>,  ref = <span class="st">"Baron"</span>, input_wt = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">0</span>))
<span class="kw">dtall_fadista</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">fdt.ens.spearman</span>, <span class="kw">fdt.seger</span>, <span class="kw">fdt.baron</span>)
<span class="kw">dtall_fadista</span><span class="op">$</span><span class="kw">refcond</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="kw">dtall_fadista</span><span class="op">$</span><span class="kw">ref</span>, <span class="kw">dtall_fadista</span><span class="op">$</span><span class="kw">condition</span>)
<span class="kw">colfunc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html">colorRampPalette</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"red"</span>, <span class="st">"white"</span>))
<span class="kw">colfunc2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/colorRamp.html">colorRampPalette</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"blue"</span>, <span class="st">"white"</span>))
<span class="kw">pfa2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">dtall_fadista</span>[<span class="kw">dtall_fadista</span><span class="op">$</span><span class="kw">refcond</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"ENSEMBLE+SpearmanR Normal"</span>, <span class="st">"Segerstolpe Normal"</span>,<span class="st">"Baron Normal"</span>,
                                                          <span class="st">"ENSEMBLE+SpearmanR T2D"</span>,<span class="st">"Segerstolpe T2D"</span>,<span class="st">"Baron T2D"</span>),], 
               <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x=<span class="kw">variable</span>, y=<span class="kw">value</span>, color = <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw">refcond</span>, levels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"ENSEMBLE+SpearmanR Normal"</span>, <span class="st">"Segerstolpe Normal"</span>,<span class="st">"Baron Normal"</span>,
                                                                           <span class="st">"ENSEMBLE+SpearmanR T2D"</span>,<span class="st">"Segerstolpe T2D"</span>,<span class="st">"Baron T2D"</span>)))) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span>(outlier.size=<span class="op">-</span><span class="fl">1</span>)<span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x=<span class="kw">variable</span>,
                  color = <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw">refcond</span>,
                                 levels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"ENSEMBLE+SpearmanR Normal"</span>, <span class="st">"Segerstolpe Normal"</span>,<span class="st">"Baron Normal"</span>,
                                            <span class="st">"ENSEMBLE+SpearmanR T2D"</span>,<span class="st">"Segerstolpe T2D"</span>,<span class="st">"Baron T2D"</span>))),
              position = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span>(<span class="fl">0.75</span>), alpha = <span class="fl">0.5</span>,cex = <span class="fl">0.25</span>)<span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(axis.text.x = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(angle = <span class="fl">30</span>, hjust = <span class="fl">1</span>, size=<span class="fl">10</span>),
        axis.text.y = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(size = <span class="fl">10</span>),
        text = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(size = <span class="fl">10</span>),
        plot.title = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(size=<span class="fl">10</span>, face = <span class="st">"bold"</span>),
        plot.margin=<span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">1</span>,<span class="op">-</span><span class="fl">5</span>,<span class="fl">0</span>), <span class="st">"mm"</span>),
        legend.position=<span class="st">"top"</span>,legend.title = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>(),
        legend.text = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(size=<span class="fl">8</span>),
        legend.box.spacing = <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span>(<span class="fl">0</span>, <span class="st">"mm"</span>))<span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span>(values=<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu">colfunc</span>(<span class="fl">10</span>)[<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>,<span class="fl">9</span>,<span class="fl">3</span>)],<span class="fu">colfunc2</span>(<span class="fl">10</span>)[<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">1</span>,<span class="fl">9</span>,<span class="fl">3</span>)])) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">""</span>) <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">""</span>)
<span class="kw">pfa2</span>
</pre></div>
<center>
<img src="../../../../../../../OneDrive%20-%20University%20of%20North%20Carolina%20at%20Chapel%20Hill/994/SCDC/package/SCDC2/SCDC/vignettes/fadista_ens.png" alt="Cell-type proportion estimation for 77 bulk samples from Fadista et al." width="600">
</center>
<p>In our paper, we sought to replicate previous findings on the negative correlation between the <a href="https://www.webmd.com/diabetes/guide/glycated-hemoglobin-test-hba1c">hemoglobin A1c</a> (HbA1c, an important biomarker for type 2 diabetes) levels and the beta cell functions ( <a href="https://care.diabetesjournals.org/content/34/4/1006.long">Kanat et al., 2011</a>, <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4657079/">Hou et al., 2016</a>). Hence, we constructed a linear model using the estimated cell-type proportions as the response variable and the other covariates (age, gender, BMI, and HbA1c) as predictors. Here we compare deconvolution results from three sources: 1) scRNA-seq from Segerstolpe et al. only; 2) scRNA-seq from Baron et al. only; 3) ENSEMBLE deconvolution results using scRNA-seq from Segerstolpe et al. and Baron et al. separately.</p>
<div class="sourceCode"><pre class="downlit">
<span class="co">## we use the scRNA-seq datasets without clustering-QC as input here, aiming to be comparable to the results as MuSiC shown in their paper.</span>
<span class="kw">baron</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"baron.rds"</span>)
<span class="kw">seger</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"segerstolpe.rds"</span>)
<span class="co">## SCDC deconvolution using one ref dataset:</span>
<span class="kw">fadista.seger</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SCDC_prop.html">SCDC_prop</a></span>(<span class="kw">fadista_77</span>, <span class="kw">seger</span>, ct.varname = <span class="st">"cluster"</span>, sample = <span class="st">"sample"</span>,
                          ct.sub = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"delta"</span>,<span class="st">"gamma"</span>,<span class="st">"acinar"</span>,<span class="st">"ductal"</span>))

<span class="kw">fadista.baron</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SCDC_prop.html">SCDC_prop</a></span>(<span class="kw">fadista_77</span>, <span class="kw">baron</span>, ct.varname = <span class="st">"cluster"</span>, sample = <span class="st">"sample"</span>,
                                ct.sub = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"delta"</span>,<span class="st">"gamma"</span>,<span class="st">"acinar"</span>,<span class="st">"ductal"</span>))
<span class="co">## ENSEMBLE proportions</span>
<span class="kw">getPropbycond</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">ens_h</span>, <span class="kw">ens_d</span>, <span class="kw">metric</span>){
  <span class="kw">prop.h</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(<span class="fu"><a href="../reference/wt_prop.html">wt_prop</a></span>(<span class="kw">ens_h</span><span class="op">$</span><span class="kw">w_table</span>[<span class="kw">metric</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>], <span class="kw">ens_h</span><span class="op">$</span><span class="kw">prop.only</span>))
  <span class="kw">prop.d</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span>(<span class="fu"><a href="../reference/wt_prop.html">wt_prop</a></span>(<span class="kw">ens_d</span><span class="op">$</span><span class="kw">w_table</span>[<span class="kw">metric</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>], <span class="kw">ens_d</span><span class="op">$</span><span class="kw">prop.only</span>))
  <span class="kw">prop2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">prop.h</span>, <span class="kw">prop.d</span>)
  <span class="kw">prop2</span><span class="op">$</span><span class="kw">condition</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"Normal"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">prop.h</span>)), <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"T2D"</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">prop.d</span>)))
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw">prop2</span>)
}

<span class="co">## combine demographic information</span>
<span class="kw">ens.spearman.prop</span> <span class="op">&lt;-</span> <span class="fu">getPropbycond</span>(ens_h = <span class="kw">fadista.healthy.ens</span>, ens_d = <span class="kw">fadista.t2d.ens</span>, metric = <span class="fl">8</span>)
</pre></div>
<p>Fit linear models: beta cell proportion ~ HbA1c + age + BMI + sex.</p>
<div class="sourceCode"><pre class="downlit">
<span class="co">## get demographic information of the bulk samples from Fadista et al.</span>
<span class="kw">fadista_demo</span> <span class="op">&lt;-</span> <span class="kw">fadista_77</span><span class="op">@</span>phenoData<span class="op">@</span>data[,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"age"</span>,<span class="st">"gender"</span>,<span class="st">"hba1c"</span>,<span class="st">"bmi"</span>,<span class="st">"hba1c_class2"</span>)]
<span class="co">## the following getLMpValue() function is to perform the linear regression and wrap the linear model results</span>
<span class="kw">getLMpValue</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">prop_est</span>, <span class="kw">method_</span>){
  <span class="kw">prop_est_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="kw">prop_est</span>, <span class="kw">fadista_demo</span>[<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="kw">prop_est</span>),])
  <span class="kw">getlmtable</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">ct</span>){
    <span class="kw">prop_est_all</span><span class="op">$</span><span class="kw">ct</span> <span class="op">&lt;-</span> <span class="kw">prop_est_all</span>[,<span class="kw">ct</span>]
    <span class="kw">lm.ens1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(<span class="kw">ct</span> <span class="op">~</span> <span class="kw">hba1c</span> <span class="op">+</span> <span class="kw">age</span> <span class="op">+</span> <span class="kw">bmi</span> <span class="op">+</span> <span class="kw">gender</span>, data = <span class="kw">prop_est_all</span>)
    <span class="kw">s1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="kw">lm.ens1</span>)
    <span class="kw">sdt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw">s1</span><span class="op">$</span><span class="kw">coefficients</span>,<span class="fl">4</span>), celltype = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="kw">ct</span>,<span class="fl">5</span>))
    <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="kw">sdt</span>)
  }
  <span class="kw">dtlm</span> <span class="op">&lt;-</span> <span class="kw">NULL</span>
  <span class="co">for</span> (<span class="kw">ct</span> <span class="co">in</span> <span class="fu"><a href="https://rdrr.io/r/base/sets.html">intersect</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"delta"</span>,<span class="st">"gamma"</span>,<span class="st">"acinar"</span>,<span class="st">"ductal"</span>),
                       <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span>(<span class="kw">prop_est</span>))){
    <span class="kw">dtlm0</span> <span class="op">&lt;-</span> <span class="fu">getlmtable</span>(<span class="kw">ct</span>)
    <span class="kw">dtlm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">dtlm</span>, <span class="kw">dtlm0</span>)
  }
  <span class="kw">dat_text_fad</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(label = <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"p-value ="</span>,<span class="kw">dtlm</span>[<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(from = <span class="fl">2</span> , to = <span class="fl">27</span>, by=<span class="fl">5</span>),<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">4</span>)]),
                             variable = <span class="kw">dtlm</span>[<span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(from = <span class="fl">2</span> , to = <span class="fl">27</span>, by=<span class="fl">5</span>),<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">5</span>)],
                             hba1c = <span class="fl">6</span>, value = <span class="fl">0.5</span>,
                             condition = <span class="st">"T2D"</span>,
                             method = <span class="kw">method_</span>)
  <span class="kw">demo_pval</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(label = <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"p-value ="</span>,<span class="kw">dtlm</span>[,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">4</span>)]),
                          variable = <span class="kw">dtlm</span>[,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">5</span>)],
                          value = <span class="fl">0.5</span>,
                          covar =<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="kw">dtlm</span>),
                          condition = <span class="st">"T2D"</span>,
                          method = <span class="kw">method_</span>)
  <span class="kw">dtmelt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span>(<span class="kw">prop_est_all</span>, id.vars = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"hba1c_class2"</span>,<span class="st">"age"</span>,<span class="st">"gender"</span>,<span class="st">"bmi"</span>,<span class="st">"hba1c"</span>), measure.vars = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"alpha"</span>,<span class="st">"beta"</span>,<span class="st">"delta"</span>,<span class="st">"gamma"</span>,<span class="st">"acinar"</span>,<span class="st">"ductal"</span>))
  <span class="kw">dtmelt</span><span class="op">$</span><span class="kw">method</span> <span class="op">&lt;-</span> <span class="kw">method_</span>
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(meltdata = <span class="kw">dtmelt</span>, pvaldata = <span class="kw">dat_text_fad</span>, demo_pval = <span class="kw">demo_pval</span>))
}
<span class="kw">res.SCDC.seger</span> <span class="op">&lt;-</span> <span class="fu">getLMpValue</span>(prop_est = <span class="kw">fadista.seger</span><span class="op">$</span><span class="kw">prop.est.mvw</span>, method_ = <span class="st">"SCDC+Segerstolpe"</span>)
<span class="kw">res.SCDC.baron</span> <span class="op">&lt;-</span> <span class="fu">getLMpValue</span>(prop_est = <span class="kw">fadista.baron</span><span class="op">$</span><span class="kw">prop.est.mvw</span>, method_ = <span class="st">"SCDC+Baron"</span>)
<span class="kw">res.SCDC.ensemble</span> <span class="op">&lt;-</span> <span class="fu">getLMpValue</span>(prop_est = <span class="kw">ens.spearman.prop</span>, method_ = <span class="st">"SCDC+ENSEMBLE"</span>)
<span class="co">## pool the results together for visualization:</span>
<span class="kw">alldata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">res.SCDC.seger</span><span class="op">$</span><span class="kw">meltdata</span>, <span class="kw">res.SCDC.ensemble</span><span class="op">$</span><span class="kw">meltdata</span>,
                 <span class="kw">res.SCDC.baron</span><span class="op">$</span><span class="kw">meltdata</span>)
<span class="kw">allpvalue</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">res.SCDC.seger</span><span class="op">$</span><span class="kw">pvaldata</span>, <span class="kw">res.SCDC.ensemble</span><span class="op">$</span><span class="kw">pvaldata</span>,
                   <span class="kw">res.SCDC.baron</span><span class="op">$</span><span class="kw">pvaldata</span>)
<span class="kw">demopval</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">res.SCDC.seger</span><span class="op">$</span><span class="kw">demo_pval</span>, <span class="kw">res.SCDC.ensemble</span><span class="op">$</span><span class="kw">demo_pval</span>,
                  <span class="kw">res.SCDC.baron</span><span class="op">$</span><span class="kw">demo_pval</span>)
<span class="kw">alldata</span><span class="op">$</span><span class="kw">method</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="kw">alldata</span><span class="op">$</span><span class="kw">method</span>)
</pre></div>
<p>Comparing ENSEMBLE proportion estimation results with the one-reference deconvolution results. Here we visualize the beta-cell proportions with the HbA1c levels, and present the p-values for HbA1c coefficient from each model.</p>
<div class="sourceCode"><pre class="downlit">
<span class="kw">fadista.LMplot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">alldata</span>[<span class="kw">alldata</span><span class="op">$</span><span class="kw">variable</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"beta"</span>),], <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x=<span class="kw">hba1c</span>, y= <span class="kw">value</span>)) <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(color = <span class="kw">hba1c_class2</span>)) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span>(method=<span class="st">'lm'</span>, se = <span class="fl">FALSE</span>, color = <span class="st">"black"</span>, lwd = <span class="fl">0.25</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(legend.position = <span class="st">"top"</span>, legend.title = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>(), <span class="co"># axis.title.x = element_blank(),</span>
        legend.box.spacing = <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span>(<span class="fl">0</span>, <span class="st">"mm"</span>),
        text = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(size=<span class="fl">9</span>),
        axis.text.x = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(size=<span class="fl">9</span>),
        axis.text.y = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(size=<span class="fl">9</span>))<span class="op">+</span><span class="co">#, axis.title.y = element_blank()) +</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span>(cols = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html">vars</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw">method</span>, levels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"SCDC+Baron"</span>, <span class="st">"SCDC+Segerstolpe"</span>, <span class="st">"SCDC+ENSEMBLE"</span>))),scales = <span class="st">"free"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span>(data = <span class="kw">allpvalue</span>[<span class="kw">allpvalue</span><span class="op">$</span><span class="kw">variable</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"beta"</span>),],
            mapping = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x=<span class="fl">5.5</span>, y=<span class="fl">0.85</span>,label = <span class="kw">label</span>),
            hjust   = <span class="fl">0.2</span>, vjust   = <span class="fl">0</span>, size = <span class="fl">2.5</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">"HbA1c"</span>) <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Proportions"</span>) <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html">ylim</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0</span>,<span class="fl">1</span>))
<span class="kw">fadista.LMplot</span>
</pre></div>
<center>
<img src="../../../../../../../OneDrive%20-%20University%20of%20North%20Carolina%20at%20Chapel%20Hill/994/SCDC/package/SCDC2/SCDC/vignettes/fadista_LMplot.png">
</center>
<p>We see that SCDC ENSEMBLE method derives the p-value of 0.0019 &lt;0.05, indicating a statistically significant association between the beta-cell proportions and the HbA1c levels.</p>
</div>
<div id="three-cell-line-mixture-data-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#three-cell-line-mixture-data-analysis" class="anchor"></a>Three Cell-line Mixture Data Analysis</h2>
<p>In the real world, some identified cell types are hard to be distinguished in certain environment. Employing a hierachical deconvolution structure (tree-guided deconvolution structure) may work better than a straightforward deconvolution. Here, using the three-cell-line mixture sample, we show how deconvolution is performed by SCDC when only one subject is available. Also, by looking at the hierarchical structure of cell lines, we see two of the cell lines are mroe closely related. Hence, we can show how a tree-guided deconvolution step is applied in this simple case.</p>
<div class="sourceCode"><pre class="downlit">
<span class="kw">qc.3cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"MIX3cl_scESET.rds"</span>)
<span class="kw">sc3cl.basis</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SCDC_basis_ONE.html">SCDC_basis_ONE</a></span>(<span class="kw">qc.3cl</span><span class="op">$</span><span class="kw">sc.eset.qc</span>, ct.varname = <span class="st">"md_cluster"</span>, sample =<span class="st">"orig.ident"</span>)
<span class="kw">df.d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/dist.html">dist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span>(<span class="kw">sc3cl.basis</span><span class="op">$</span><span class="kw">basis.mvw</span> <span class="op">+</span> <span class="fl">1e-10</span>)), method = <span class="st">"euclidean"</span>)
<span class="kw">hc1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/hclust.html">hclust</a></span>(<span class="kw">df.d</span>, method = <span class="st">"complete"</span>)
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span>(<span class="kw">hc1</span>, cex = <span class="fl">0.8</span>, hang = <span class="op">-</span><span class="fl">1</span>, main = <span class="st">"log(basis matrix)"</span>)
</pre></div>
<center>
<img src="../../../../../../../OneDrive%20-%20University%20of%20North%20Carolina%20at%20Chapel%20Hill/994/SCDC/package/SCDC2/SCDC/vignettes/hc_3cl.png">
</center>
<p>The tree-structured deconvolution procedure will allow users to specify a 'meta cluster' by their own professional judgment. Without the requirement for marker genes input, we could employ the function <code><a href="../reference/SCDC_prop_ONE_subcl_marker.html">SCDC_prop_ONE_subcl_marker()</a></code> to deconvolve the bulk samples.</p>
<div class="sourceCode"><pre class="downlit">
<span class="kw">bulk3cl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"MIX3cl_bulkESET.rds"</span>)
<span class="kw">sc3cl2</span> <span class="op">&lt;-</span> <span class="kw">qc.3cl</span><span class="op">$</span><span class="kw">sc.eset.qc</span>
<span class="kw">sc3cl2</span><span class="op">$</span><span class="kw">md_cluster2</span> <span class="op">&lt;-</span> <span class="kw">sc3cl2</span><span class="op">$</span><span class="kw">md_cluster</span>
<span class="kw">sc3cl2</span><span class="op">$</span><span class="kw">md_cluster2</span>[<span class="op">!</span><span class="kw">sc3cl2</span><span class="op">$</span><span class="kw">md_cluster2</span> <span class="op">%in%</span> <span class="st">"NormalFibroblast"</span>] <span class="op">&lt;-</span> <span class="st">"Tumor"</span>
<span class="co"># deconv_3cl &lt;- SCDC_prop_ONE(bulk.eset = bulk3cl, sc.eset = sc3cl2, ct.varname = "md_cluster", sample = "orig.ident", ct.sub = unique(sc3cl$md_cluster), weight.basis = T)</span>
<span class="kw">SCDC_3cl_tree</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SCDC_prop_ONE_subcl_marker.html">SCDC_prop_ONE_subcl_marker</a></span>(bulk.eset = <span class="kw">bulk3cl</span>, sc.eset = <span class="kw">sc3cl2</span>, ct.varname = <span class="st">"md_cluster"</span>,
                                             sample = <span class="st">"orig.ident"</span>, ct.sub = <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">sc3cl2</span><span class="op">$</span><span class="kw">md_cluster</span>),
                                             ct.fl.sub = <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">sc3cl2</span><span class="op">$</span><span class="kw">md_cluster2</span>) , weight.basis = <span class="kw">T</span>,
                                             fl.varname = <span class="st">"md_cluster2"</span>, select.marker = <span class="kw">T</span>, LFC.lim = <span class="fl">5</span>)
<span class="co">#&gt; WNNLS for Second level clusters MCF7 MDA-MB468 Converged at iteration  3</span>
<span class="kw">SCDC_3cl_tree</span><span class="op">$</span><span class="kw">prop.est</span>
<span class="co">#&gt;        MCF7 MDA-MB468 NormalFibroblast</span>
<span class="co">#&gt; 1 0.2561348 0.6367564        0.1071088</span>
</pre></div>
<p>The choice of limit for LogFoldChange <code>LFC.lim=5</code> could be changed by users. Empirically, a good threshold value would cut the number of genes to 1000~2000, which we believe is an adequate number to detect the inter-cell-type variations.</p>
</div>
<div id="mouse-mammary-gland-data-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#mouse-mammary-gland-data-analysis" class="anchor"></a>Mouse Mammary Gland Data Analysis</h2>
<p>Using the single cell clustering package <a href="https://satijalab.org/seurat/">Seurat</a>, we classified the mouse mammary gland single cells into five cell types of interest: endothelial, fibroblast, luminal, basal and immune cells. In our paper, we perform deconvolution for mouse mammary gland tissue bulk RNA-seq data of two forms: fresh-frozen and 10X. The detailed data process structure is shown in the figure 5 of our paper.</p>
<p>For illustration purpose, we only show how deconvolution of the 10X bulk samples is performed as follows. The processed fresh-frozen bulk RNA-seq data is also available at our data download page.</p>
<p>First we show the deconvolution using function <code><a href="../reference/SCDC_prop_subcl_marker.html">SCDC_prop_subcl_marker()</a></code> utilizing each of the single cell reference dataset separately.</p>
<div class="sourceCode"><pre class="downlit">
<span class="co">## read in ExpressionSet object from Perou lab, and Tabula Muris</span>
<span class="kw">bulk10x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"peroubulk10x_fvb34.rds"</span>)
<span class="kw">qc.perou</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"qc_perou.rds"</span>)
<span class="kw">qc.tmouse</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span>(<span class="st">"qc_tmouse.rds"</span>)

<span class="co">## you could try the SCDC_prop() function for deconvolution without tree-guided structure first, </span>
<span class="co">## but based on biological knowledge and the single cell information we have now, the proportions estimation result</span>
<span class="co">## might not reflect the proportions that are close to truth.</span>

<span class="co">## here, tree-guided two-level deconvolution is performed (takes around 2 min):</span>
<span class="kw">perou</span> <span class="op">&lt;-</span> <span class="kw">qc.perou</span><span class="op">$</span><span class="kw">sc.eset.qc</span>
<span class="kw">tmouse</span> <span class="op">&lt;-</span> <span class="kw">qc.tmouse</span><span class="op">$</span><span class="kw">sc.eset.qc</span>

<span class="kw">perou</span><span class="op">$</span><span class="kw">metacluster2</span>[<span class="kw">perou</span><span class="op">$</span><span class="kw">md_cluster</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>( <span class="st">"immune"</span>)] <span class="op">&lt;-</span> <span class="st">"immune"</span>
<span class="kw">perou</span><span class="op">$</span><span class="kw">metacluster2</span>[<span class="kw">perou</span><span class="op">$</span><span class="kw">md_cluster</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"basal"</span>,<span class="st">"luminal"</span>,<span class="st">"fibroblast"</span>,<span class="st">"endothelial"</span>)] <span class="op">&lt;-</span> <span class="st">"BaLuFibEndo"</span>
<span class="kw">perou.subcl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SCDC_prop_subcl_marker.html">SCDC_prop_subcl_marker</a></span>(bulk.eset = <span class="kw">bulk10x</span>, sc.eset = <span class="kw">perou</span>, ct.varname = <span class="st">"md_cluster"</span>, fl.varname = <span class="st">"metacluster2"</span>, sample = <span class="st">"subj"</span>, ct.sub = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"endothelial"</span>,<span class="st">"fibroblast"</span>,<span class="st">"immune"</span>,<span class="st">"luminal"</span>,<span class="st">"basal"</span>), ct.fl.sub = <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">perou</span><span class="op">$</span><span class="kw">metacluster2</span>), select.marker = <span class="kw">T</span>, LFC.lim = <span class="fl">5</span>)

<span class="kw">tmouse</span><span class="op">$</span><span class="kw">metacluster2</span>[<span class="kw">tmouse</span><span class="op">$</span><span class="kw">md_cluster</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"immune"</span>)] <span class="op">&lt;-</span> <span class="st">"immune"</span>
<span class="kw">tmouse</span><span class="op">$</span><span class="kw">metacluster2</span>[<span class="kw">tmouse</span><span class="op">$</span><span class="kw">md_cluster</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"endothelial"</span>, <span class="st">"fibroblast"</span>,<span class="st">"luminal"</span>,<span class="st">"basal"</span>)] <span class="op">&lt;-</span> <span class="st">"BaLuFibEndo"</span>
<span class="kw">tmouse.subcl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SCDC_prop_subcl_marker.html">SCDC_prop_subcl_marker</a></span>(bulk.eset = <span class="kw">bulk10x</span>, sc.eset = <span class="kw">tmouse</span>, ct.varname = <span class="st">"md_cluster"</span>, fl.varname = <span class="st">"metacluster2"</span>, sample = <span class="st">"subj"</span>, ct.sub = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"endothelial"</span>,<span class="st">"fibroblast"</span>,<span class="st">"immune"</span>,<span class="st">"luminal"</span>,<span class="st">"basal"</span>), ct.fl.sub = <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="kw">tmouse</span><span class="op">$</span><span class="kw">metacluster2</span>), select.marker = <span class="kw">T</span>, LFC.lim = <span class="fl">5</span>)
</pre></div>
<p>Then we proceed with the ENSEMBLE step. Note that you can also input the deconvolution results from other methods like MuSiC, CIBERSORTx, Bisque, etc. The input elements we require here consist of at least two parts: the basis/signature/feature/profile matrix (genes by cell types), and the estimated cell-type proportions matrix (cell types by samples). We provide the function <code>CreateSCDCpropObj</code> to create object as such input format.</p>
<div class="sourceCode"><pre class="downlit">
<span class="co">## </span>
<span class="kw">ens_subcl_perou10x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/SCDC_ENSEMBLE.html">SCDC_ENSEMBLE</a></span>(bulk.eset = <span class="kw">bulk10x</span>, prop.input = <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(tmouse.subcl = <span class="kw">tmouse.subcl</span>, perou.subcl = <span class="kw">perou.subcl</span>), ct.sub = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"endothelial"</span>,<span class="st">"fibroblast"</span>,<span class="st">"immune"</span>,<span class="st">"luminal"</span>,<span class="st">"basal"</span>), search.length = <span class="fl">0.01</span>, grid.search = <span class="kw">T</span>)
<span class="kw">ens_subcl_perou10x</span><span class="op">$</span><span class="kw">w_table</span>
</pre></div>
<p>The following code visualizes the SCDC estimation results. <code>getPearson</code> is a function calculating the Pearson correlation between two (estimated) datasets for the selected subjects (subj) and cell types (ct). <code>ens_res</code> is the function to summarize the ENSEMBLE results. wt is a vector of estimated weights which should sum up to 1. proplist is a list of estimated proportion matrix corresponding to the reference datasets in the same order with wt. subject is a vector which specifies the name of subjects of interest. <code>getENSplot</code> is the function to generate the final ENSEMBLE plot. enstable is a matrix which usually is the selected <code>your_ENSEMBLE_result$w_table</code>. You can specify your own designed weights for the references also. each row is a set of weights and each column correspond to a reference dataset. combo is a list of estimated proportion matrices derieved from SCDC or other deconvolution methods. The order of the lists should be consistent with the column order in the weight table (enstable). subject specifies the subjects of interest in your bulk samples. subcat is optional, and it can help you select a subset of ENSEMBLE method options. To specify subcat, it should be a subset of rownames of your enstable.</p>
<div class="sourceCode"><pre class="downlit">
<span class="kw">getPearson</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">dt1</span>, <span class="kw">dt2</span>, <span class="kw">ct</span>, <span class="kw">subj</span>){
  <span class="fu"><a href="https://rdrr.io/r/stats/cor.html">cor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">dt1</span>[<span class="kw">subj</span>,<span class="kw">ct</span>]), <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">dt2</span>[<span class="kw">subj</span>,<span class="kw">ct</span>]))
}
<span class="kw">ens_res</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">wt</span>, <span class="kw">proplist</span>, <span class="kw">subject</span> = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"FVB3"</span>,<span class="st">"FVB4"</span>)){
  <span class="kw">ens</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/wt_prop.html">wt_prop</a></span>(<span class="kw">wt</span>, proplist = <span class="kw">proplist</span>) 
  <span class="kw">p.ens</span> <span class="op">&lt;-</span> <span class="fu">getPearson</span>(<span class="kw">perou_pseudo_all</span><span class="op">$</span><span class="kw">truep</span>, <span class="kw">ens</span> ,
                      ct = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"endothelial"</span>,<span class="st">"fibroblast"</span>,<span class="st">"luminal"</span>,<span class="st">"basal"</span>,<span class="st">"immune"</span>), subj = <span class="kw">subject</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(prop = <span class="kw">ens</span>, p = <span class="kw">p.ens</span>))
}
<span class="kw">combo.10x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span>(<span class="kw">ens_subcl_perou10x</span><span class="op">$</span><span class="kw">prop.list</span>, <span class="fu">function</span>(<span class="kw">x</span>){
  <span class="kw">x</span><span class="op">$</span><span class="kw">prop.est</span>[,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"endothelial"</span>,<span class="st">"fibroblast"</span>,<span class="st">"luminal"</span>,<span class="st">"basal"</span>,<span class="st">"immune"</span>)] 
})

<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/hadley/reshape">reshape2</a></span>)
<span class="kw">ct1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"mediumorchid1"</span>,<span class="st">"mediumpurple1"</span>,<span class="st">"lightskyblue"</span>,<span class="st">"seagreen1"</span>,<span class="st">"yellow"</span>,<span class="st">"tan1"</span>,<span class="st">"azure3"</span>)
<span class="kw">perou_pseudo_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generateBulk_allcells.html">generateBulk_allcells</a></span>(<span class="kw">perou</span>, ct.varname = <span class="st">'md_cluster'</span>, sample = <span class="st">'subj'</span>, ct.sub = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"endothelial"</span>,<span class="st">"fibroblast"</span>,<span class="st">"immune"</span>,<span class="st">"luminal"</span>,<span class="st">"basal"</span>))

<span class="kw">getENSplot</span> <span class="op">&lt;-</span> <span class="fu">function</span>(<span class="kw">enstable</span>, <span class="kw">combo</span>, <span class="kw">subject</span>, <span class="kw">subcat</span> = <span class="kw">NULL</span>){
  <span class="co">if</span> (<span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span>(<span class="kw">subcat</span>)){
    <span class="kw">enstable</span> <span class="op">&lt;-</span> <span class="kw">enstable</span>[<span class="kw">subcat</span>,]
  }
  <span class="kw">wtres.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>()
  <span class="co">for</span> (<span class="kw">i</span> <span class="co">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">enstable</span>)){
    <span class="kw">wtres.list</span>[[<span class="kw">i</span>]] <span class="op">&lt;-</span> <span class="fu">ens_res</span>(<span class="kw">enstable</span>[<span class="kw">i</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>], <span class="kw">combo</span>)<span class="op">$</span><span class="kw">prop</span>
  }
  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="kw">wtres.list</span>) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="kw">enstable</span>)
  <span class="kw">pcor.list</span> <span class="op">&lt;-</span> <span class="kw">NULL</span>
  <span class="co">for</span> (<span class="kw">i</span> <span class="co">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="kw">enstable</span>)){
    <span class="kw">pcor.list</span>[[<span class="kw">i</span>]] <span class="op">&lt;-</span> <span class="fu">ens_res</span>(<span class="kw">enstable</span>[<span class="kw">i</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>], <span class="kw">combo</span>, subject = <span class="kw">subject</span>)<span class="op">$</span><span class="kw">p</span>
  }
  <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="kw">pcor.list</span>) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="kw">enstable</span>)
  <span class="kw">est.all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(<span class="kw">perou_pseudo_all</span><span class="op">$</span><span class="kw">truep</span>[,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"endothelial"</span>,<span class="st">"fibroblast"</span>,<span class="st">"luminal"</span>,<span class="st">"basal"</span>,<span class="st">"immune"</span>)],
                   <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="kw">rbind</span>, <span class="kw">combo</span>), 
                   <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="kw">rbind</span>, <span class="kw">wtres.list</span>))
  <span class="kw">est.all.3</span> <span class="op">&lt;-</span> <span class="kw">est.all</span>[<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="kw">est.all</span>) <span class="op">==</span> <span class="kw">subject</span>,]
  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span>(<span class="kw">est.all.3</span>) <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Seurat"</span>, <span class="st">"Tabula Muris"</span>, <span class="st">"Perou"</span>, 
                                     <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"ENSEMBLE:"</span>,<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="kw">pcor.list</span>))))
  
  <span class="kw">p_t</span> <span class="op">&lt;-</span> <span class="fu">getPearson</span>(<span class="kw">perou_pseudo_all</span><span class="op">$</span><span class="kw">truep</span>, <span class="kw">combo</span>[[<span class="fl">1</span>]],
                    ct = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"endothelial"</span>,<span class="st">"fibroblast"</span>,<span class="st">"luminal"</span>,<span class="st">"basal"</span>,<span class="st">"immune"</span>), subj = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">subject</span>))
  <span class="kw">p_p</span> <span class="op">&lt;-</span> <span class="fu">getPearson</span>(<span class="kw">perou_pseudo_all</span><span class="op">$</span><span class="kw">truep</span>, <span class="kw">combo</span>[[<span class="fl">2</span>]],
                    ct = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"endothelial"</span>,<span class="st">"fibroblast"</span>,<span class="st">"luminal"</span>,<span class="st">"basal"</span>,<span class="st">"immune"</span>), subj = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">subject</span>))
  <span class="kw">dat_text</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(label = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">""</span>,<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"R="</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="kw">p_t</span>, <span class="kw">p_p</span>, <span class="kw">pcor.list</span>),<span class="fl">2</span>), sep = <span class="st">""</span>)),
                         Var1 = <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Seurat"</span>, <span class="st">"Tabula Muris"</span>, <span class="st">"Perou"</span>, 
                                            <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"ENSEMBLE:"</span>,<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span>(<span class="kw">pcor.list</span>)))),
                         value =<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0.9</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">pcor.list</span>)<span class="op">+</span><span class="fl">3</span>),
                         Var2 = <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="st">"endothelial"</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="kw">pcor.list</span>)<span class="op">+</span><span class="fl">3</span>))
  <span class="kw">meltdt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span>(<span class="kw">est.all.3</span>)
  <span class="kw">P</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">meltdt</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x=<span class="kw">Var1</span>, y=<span class="kw">value</span>, fill = <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="kw">Var2</span>, levels = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"endothelial"</span>,<span class="st">"fibroblast"</span>,<span class="st">"luminal"</span>,<span class="st">"basal"</span>,<span class="st">"immune"</span>)))) <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html">geom_bar</a></span>(stat = <span class="st">"identity"</span>) <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span>(<span class="st">""</span>) <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"Percentage"</span>) <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span>(axis.text.x = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(angle = <span class="fl">30</span>, hjust = <span class="fl">1</span>, size=<span class="fl">10</span>),
          axis.text.y = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(size = <span class="fl">10</span>),
          text = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(size = <span class="fl">10</span>),
          plot.title = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(size=<span class="fl">10</span>, face = <span class="st">"bold"</span>),
          plot.margin=<span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">1</span>,<span class="op">-</span><span class="fl">5</span>,<span class="fl">0</span>), <span class="st">"mm"</span>),
          legend.position=<span class="st">"top"</span>,legend.title = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>(),
          legend.text = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span>(size=<span class="fl">8</span>),
          legend.box.spacing = <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span>(<span class="fl">0</span>, <span class="st">"mm"</span>),
          panel.grid.major = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>(), panel.grid.minor = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>(),
          panel.background = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span>(), axis.line = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_line</a></span>(colour = <span class="st">"black"</span>))<span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_fill_manual</a></span>(values=<span class="kw">ct1</span>) <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span>(fill = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span>(nrow = <span class="fl">2</span>))<span class="op">+</span>
    <span class="co"># facet_grid(cols = vars(ref)) +</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html">geom_text</a></span>(data = <span class="kw">dat_text</span>,
              mapping = <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(x=<span class="kw">Var1</span>, y=<span class="kw">value</span>,label = <span class="kw">label</span>),
              hjust   = <span class="fl">0.5</span>, vjust   = <span class="fl">0</span>)
  <span class="co"># png(file.path(vpath,  "mammarygland.png"), res = 80, height = 300, width = 300)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span>(<span class="kw">P</span>)
  <span class="co"># dev.off()</span>
}

<span class="fu">getENSplot</span>(enstable = <span class="kw">ens_subcl_perou10x</span><span class="op">$</span><span class="kw">w_table</span>, combo=<span class="kw">combo.10x</span>, subject = <span class="st">"FVB3"</span>, subcat = <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"Spearman_Y"</span>,<span class="st">"LAD"</span>))
</pre></div>
<p>Visualization of the proportion estimation results:</p>
<center>
<img src="../../../../../../../OneDrive%20-%20University%20of%20North%20Carolina%20at%20Chapel%20Hill/994/SCDC/package/SCDC2/SCDC/vignettes/mammarygland.png">
</center>
<!-- 
pending... -->
<p>For simple deconvolution aims, SCDC provides the <code><a href="../reference/deconv_simple.html">deconv_simple()</a></code> function to allow users to specify a pre-processed bulk sample matrix "count.filter.norm", and a pre-calculated basis matrix "basis.norm" for deconvolution. Thus, by iterative weighted-NNLS, the cell-type proportion would be estimated. One example will be:</p>
<div class="sourceCode"><pre class="downlit">
<span class="kw">res</span> <span class="op">=</span> <span class="fu"><a href="../reference/deconv_simple.html">deconv_simple</a></span>(<span class="kw">count.filter.norm</span>, <span class="kw">basis.norm</span>)
<span class="kw">res</span><span class="op">$</span><span class="kw">prop.est.mvw</span>
</pre></div>
<p><font color="blue"> <em>Thanks for using SCDC! Please feel free to reach out (<a href="mailto:meichen@live.unc.edu">meichen@live.unc.edu</a>) if you have questions!</em> </font></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Meichen Dong.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
